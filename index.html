<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dassger Ultra | Final Full Script</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030303;
            --card: rgba(22, 22, 22, 0.85);
            --accent: #ffffff;
            --text: #ffffff;
            --text-dim: #777;
            --danger: #ff3b3b;
            --glass: blur(25px) saturate(180%);
            --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% -20%, #333 0%, #030303 90%); 
            color: var(--text); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
        }

        .glass { background: var(--card); backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); border: 1px solid rgba(255,255,255,0.1); }
        .hover-scale:active { transform: scale(0.96); opacity: 0.8; transition: 0.1s; }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { width: 90%; max-width: 400px; padding: 50px; border-radius: 45px; text-align: center; box-shadow: 0 40px 80px rgba(0,0,0,0.8); }
        .logo { font-size: 56px; font-weight: 800; letter-spacing: -4px; margin-bottom: 15px; background: linear-gradient(to bottom, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* MAIN LAYOUT */
        .app-container { display: flex; width: 100%; height: 100vh; padding: 25px; gap: 20px; }
        
        @media (max-width: 850px) { 
            .app-container { padding: 0; gap: 0; }
            .sidebar { border-radius: 0 !important; width: 100% !important; }
            .main-chat { border-radius: 0 !important; position: absolute !important; inset: 0; transform: translateX(100%); z-index: 100; }
            .main-chat.active { transform: translateX(0); }
            .back-btn { display: block !important; }
        }

        .sidebar { width: 400px; display: flex; flex-direction: column; border-radius: 40px; overflow: hidden; }
        .main-chat { flex: 1; display: flex; flex-direction: column; border-radius: 40px; overflow: hidden; position: relative; transition: var(--transition); }

        /* INPUTS & BUTTONS */
        input { width: 100%; padding: 20px; margin: 10px 0; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; color: #fff; outline: none; transition: var(--transition); font-size: 16px; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 25px rgba(255,255,255,0.1); }
        
        button { width: 100%; padding: 20px; background: var(--accent); color: #000; border: none; border-radius: 25px; font-weight: 800; cursor: pointer; box-shadow: 0 10px 30px rgba(255,255,255,0.15); font-size: 15px; }

        /* AVATARS */
        .avatar { width: 60px; height: 60px; border-radius: 22px; background: linear-gradient(135deg, #555, #111); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.15); overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* MESSAGES */
        .messages { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .bubble { max-width: 75%; padding: 18px 24px; border-radius: 28px; font-size: 16px; line-height: 1.5; animation: msgPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        @keyframes msgPop { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .mine { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 4px; box-shadow: 0 8px 20px rgba(255,255,255,0.1); }
        .theirs { align-self: flex-start; background: rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }

        /* CONTACTS */
        .contact-item { padding: 20px 25px; margin: 0 15px 12px; border-radius: 28px; cursor: pointer; display: flex; align-items: center; gap: 20px; transition: var(--transition); }
        .contact-item:hover { background: rgba(255,255,255,0.06); }
        .contact-item.active { background: rgba(255,255,255,0.12); border-left: 5px solid #fff; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(25px); }
        .modal-card { width: 92%; max-width: 440px; padding: 45px; border-radius: 50px; text-align: center; border: 1px solid rgba(255,255,255,0.15); }
        
        .lang-switch { display: flex; gap: 12px; justify-content: center; margin-bottom: 30px; }
        .lang-pill { padding: 10px 22px; border-radius: 16px; font-size: 14px; cursor: pointer; background: rgba(255,255,255,0.08); transition: 0.3s; }
        .lang-pill.active { background: #fff; color: #000; font-weight: 800; }

        .hidden { display: none !important; }
        .back-btn { display: none; background: none; border: none; color: white; font-size: 32px; padding: 0 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card glass">
            <div class="logo">Dassger</div>
            <div class="lang-switch">
                <div class="lang-pill active" data-l="ru">RU</div>
                <div class="lang-pill" data-l="en">EN</div>
            </div>
            <p id="auth-desc" style="color: var(--text-dim); margin-bottom: 30px; font-size: 15px; line-height: 1.5;"></p>
            <input type="text" id="reg-nickname" autocomplete="off" placeholder="...">
            <button id="btn-create" class="hover-scale"></button>
        </div>
    </div>

    <div id="modal-settings" class="modal">
        <div class="modal-card glass">
            <h2 id="set-title" style="margin-bottom: 30px; font-size: 28px;"></h2>
            
            <div style="position: relative; width: 130px; height: 130px; margin: 0 auto 30px;">
                <div class="avatar" id="set-avatar-preview" style="width: 100%; height: 100%; border-radius: 45px; font-size: 48px;"></div>
                <input type="file" id="file-avatar" hidden accept="image/*">
                <div id="trigger-file-input" style="position: absolute; inset: 0; cursor: pointer; background: rgba(0,0,0,0); border-radius: 45px;"></div>
            </div>
            
            <button id="btn-change-photo" class="hover-scale" style="background: rgba(255,255,255,0.1); color: #fff; margin-bottom: 20px;"></button>
            <input type="text" id="set-nickname-input">
            <p id="display-my-id" style="font-size: 12px; color: var(--text-dim); margin: 20px 0; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 30px; cursor: pointer; border: 1px dashed rgba(255,255,255,0.2);"></p>
            
            <button id="btn-save" class="hover-scale" style="margin-bottom: 15px;"></button>
            <button id="btn-nuke" class="hover-scale" style="background: var(--danger); color: white;"></button>
            <button id="btn-cancel" style="background:none; color: var(--text-dim); margin-top: 20px; box-shadow: none;"></button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar glass">
            <div style="padding: 40px;">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 35px; cursor: pointer;" id="trigger-settings">
                    <div class="avatar" id="my-avatar"></div>
                    <div style="flex:1">
                        <b id="my-name-label" style="font-size: 22px; display: block; letter-spacing: -0.5px;"></b>
                        <span id="my-status" style="font-size: 12px; color: var(--text-dim); font-weight: 600;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 15px;">
                    <input type="text" id="conn-id" style="margin:0;">
                    <button id="btn-add" class="hover-scale" style="width: 70px; box-shadow: none;">+</button>
                </div>
            </div>
            <div id="contact-list" style="flex:1; overflow-y:auto; padding-bottom: 40px;"></div>
        </aside>

        <main class="main-chat glass" id="chat-window">
            <div style="padding: 25px 35px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                <button class="back-btn" id="trigger-back">←</button>
                <div class="avatar" id="chat-avatar" style="width:48px; height:48px; border-radius: 18px;"></div>
                <div>
                    <b id="chat-name" style="font-size: 20px; letter-spacing: -0.5px;"></b>
                    <div id="chat-id-label" style="font-size: 11px; color: var(--text-dim); font-weight: 700;"></div>
                </div>
            </div>
            <div class="messages" id="msg-box"></div>
            <div style="padding: 30px 35px; display: flex; gap: 15px; background: rgba(0,0,0,0.35);">
                <input type="text" id="msg-input" style="margin:0;" autocomplete="off">
                <button id="btn-send" class="hover-scale" style="width: 110px;"></button>
            </div>
        </main>
    </div>

    <script>
        const i18n = {
            ru: {
                authDesc: "Ваш первый никнейм создаст вечный зашифрованный ID",
                regNick: "Придумайте ник...",
                btnCreate: "Создать аккаунт",
                setTitle: "Ваш профиль",
                btnPhoto: "Смена фото (клик на аватар)",
                setNick: "Имя в чате",
                btnSave: "Сохранить изменения",
                btnNuke: "Удалить аккаунт",
                btnCancel: "Вернуться",
                myStatus: "В сети • Настройки",
                friendId: "ID собеседника...",
                selectChat: "Выберите чат",
                btnSend: "ОК",
                copy: "Нажми, чтобы скопировать свой ID",
                confirm: "Удалить все данные навсегда?",
                copied: "ID успешно скопирован!"
            },
            en: {
                authDesc: "Your first nickname creates a permanent encrypted ID",
                regNick: "Pick a nickname...",
                btnCreate: "Start Chatting",
                setTitle: "Profile Settings",
                btnPhoto: "Change Avatar (tap image)",
                setNick: "Display Name",
                btnSave: "Save Changes",
                btnNuke: "Delete Account",
                btnCancel: "Back",
                myStatus: "Online • Settings",
                friendId: "Peer ID...",
                selectChat: "Select a Contact",
                btnSend: "Send",
                copy: "Click to copy your unique ID",
                confirm: "Delete everything forever?",
                copied: "ID copied to clipboard!"
            }
        };

        let lang = localStorage.getItem('dg_lang') || 'ru';
        let peer, conn, activeId = null;
        let profile = JSON.parse(localStorage.getItem('dg_v11_profile'));
        let history = JSON.parse(localStorage.getItem('dg_v11_history')) || {};

        function updateLang() {
            const t = i18n[lang];
            document.querySelectorAll('.lang-pill').forEach(p => p.classList.toggle('active', p.dataset.l === lang));
            document.getElementById('auth-desc').innerText = t.authDesc;
            document.getElementById('reg-nickname').placeholder = t.regNick;
            document.getElementById('btn-create').innerText = t.btnCreate;
            document.getElementById('set-title').innerText = t.setTitle;
            document.getElementById('btn-change-photo').innerText = t.btnPhoto;
            document.getElementById('set-nickname-input').placeholder = t.setNick;
            document.getElementById('btn-save').innerText = t.btnSave;
            document.getElementById('btn-nuke').innerText = t.btnNuke;
            document.getElementById('btn-cancel').innerText = t.btnCancel;
            document.getElementById('my-status').innerText = t.myStatus;
            document.getElementById('conn-id').placeholder = t.friendId;
            document.getElementById('btn-send').innerText = t.btnSend;
            if(!activeId) document.getElementById('chat-name').innerText = t.selectChat;
        }

        function initPeer(id) {
            peer = new Peer(id);
            peer.on('open', () => { renderSidebar(); renderContacts(); });
            peer.on('connection', (c) => { conn = c; handleConn(); });
            peer.on('error', (err) => { if(err.type === 'peer-unavailable') alert("User is offline"); });
        }

        function handleConn() {
            conn.on('open', () => {
                activeId = conn.peer;
                if(!history[activeId]) history[activeId] = { name: conn.metadata?.name || activeId, av: conn.metadata?.av, msgs: [] };
                openChat();
            });
            conn.on('data', (d) => {
                if(d.type === 'meta') { 
                    history[conn.peer].name = d.name; 
                    history[conn.peer].av = d.av; 
                    if(activeId === conn.peer) updateHeader();
                } else {
                    pushMsg(conn.peer, 'theirs', d.content);
                }
                if(activeId === conn.peer) renderMsgs();
                renderContacts();
            });
        }

        function openChat() {
            document.getElementById('chat-window').classList.add('active');
            updateHeader();
            renderMsgs();
        }

        function updateHeader() {
            const u = history[activeId];
            document.getElementById('chat-name').innerText = u.name;
            document.getElementById('chat-id-label').innerText = "ID: " + activeId;
            drawAv('chat-avatar', u.av, u.name);
        }

        function pushMsg(pid, side, content) {
            if(!history[pid]) history[pid] = { name: pid, msgs: [] };
            history[pid].msgs.push({ side, content });
            localStorage.setItem('dg_v11_history', JSON.stringify(history));
        }

        function renderMsgs() {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            (history[activeId]?.msgs || []).forEach(m => {
                const d = document.createElement('div');
                d.className = `bubble ${m.side}`;
                d.innerText = m.content;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function renderContacts() {
            const list = document.getElementById('contact-list');
            list.innerHTML = "";
            Object.keys(history).forEach(id => {
                const u = history[id];
                const d = document.createElement('div');
                d.className = `contact-item ${activeId === id ? 'active' : ''}`;
                d.onclick = () => { activeId = id; conn = peer.connect(id, {metadata:{name:profile.name, av:profile.av}}); handleConn(); };
                d.innerHTML = `<div class="avatar">${u.av ? '<img src="'+u.av+'">' : u.name[0].toUpperCase()}</div><b>${u.name}</b>`;
                list.appendChild(d);
            });
        }

        function renderSidebar() {
            document.getElementById('my-name-label').innerText = profile.name;
            drawAv('my-avatar', profile.av, profile.name);
        }

        function drawAv(elId, src, nick) {
            const el = document.getElementById(elId);
            if(src) el.innerHTML = `<img src="${src}">`;
            else el.innerText = nick ? nick[0].toUpperCase() : '?';
        }

        // AVATAR CHANGE LOGIC
        const fInput = document.getElementById('file-avatar');
        const trigger = document.getElementById('trigger-file-input');
        
        trigger.onclick = () => fInput.click();
        document.getElementById('btn-change-photo').onclick = () => fInput.click();

        fInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                profile.av = ev.target.result;
                drawAv('set-avatar-preview', profile.av, profile.name);
            };
            reader.readAsDataURL(file);
        };

        // EVENTS
        document.querySelectorAll('.lang-pill').forEach(p => {
            p.onclick = () => { lang = p.dataset.l; localStorage.setItem('dg_lang', lang); updateLang(); };
        });

        document.getElementById('btn-create').onclick = () => {
            const nick = document.getElementById('reg-nickname').value.trim();
            if(!nick) return;
            const id = "dg_" + nick.toLowerCase().replace(/[^a-z]/g, "") + "_" + Math.floor(Math.random()*9999);
            profile = { id, name: nick, av: null };
            localStorage.setItem('dg_v11_profile', JSON.stringify(profile));
            location.reload();
        };

        document.getElementById('btn-add').onclick = () => {
            const id = document.getElementById('conn-id').value.trim();
            if(!id || id === profile.id) return;
            conn = peer.connect(id, {metadata:{name:profile.name, av:profile.av}});
            handleConn();
        };

        document.getElementById('btn-send').onclick = () => {
            const i = document.getElementById('msg-input');
            if(!i.value.trim() || !conn) return;
            conn.send({ content: i.value });
            pushMsg(activeId, 'mine', i.value);
            i.value = ""; renderMsgs();
        };

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key==='Enter') document.getElementById('btn-send').click(); };

        document.getElementById('trigger-settings').onclick = () => {
            document.getElementById('modal-settings').style.display = 'flex';
            document.getElementById('set-nickname-input').value = profile.name;
            document.getElementById('display-my-id').innerText = i18n[lang].copy + "\n" + profile.id;
            drawAv('set-avatar-preview', profile.av, profile.name);
        };

        document.getElementById('display-my-id').onclick = () => {
            navigator.clipboard.writeText(profile.id);
            alert(i18n[lang].copied);
        };

        document.getElementById('btn-save').onclick = () => {
            profile.name = document.getElementById('set-nickname-input').value.trim() || profile.name;
            localStorage.setItem('dg_v11_profile', JSON.stringify(profile));
            renderSidebar(); 
            document.getElementById('modal-settings').style.display = 'none';
            if(conn) conn.send({type:'meta', name:profile.name, av:profile.av});
        };

        document.getElementById('btn-nuke').onclick = () => {
            if(confirm(i18n[lang].confirm)) { localStorage.clear(); location.reload(); }
        };

        document.getElementById('btn-cancel').onclick = () => document.getElementById('modal-settings').style.display = 'none';
        document.getElementById('trigger-back').onclick = () => { document.getElementById('chat-window').classList.remove('active'); activeId = null; };

        if(profile)

{ document.getElementById('auth-s creen').classList.add('hidden');

initPeer (profile.id); }

updateLang();

</script>

</body>

</html>
