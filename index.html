<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dassger</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000; --surf: #111; --brd: #222; --acc: #fff; --txt: #fff; --dim: #666; --danger: #ff4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--txt); height: 100vh; overflow: hidden; }
        
        /* Стили экранов */
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; }
        .screen.active { display: flex; }
        
        /* Авторизация */
        #auth-screen { align-items: center; justify-content: center; background: #000; }
        .auth-box { width: 90%; max-width: 320px; text-align: center; }

        /* Основной интерфейс */
        .container { display: flex; width: 100%; height: 100vh; }
        .sidebar { width: 320px; border-right: 1px solid var(--brd); display: flex; flex-direction: column; background: #000; }
        .main { flex: 1; display: flex; flex-direction: column; background: #000; transition: transform 0.3s ease; }

        /* Ввод и кнопки */
        input { width: 100%; padding: 14px; background: var(--surf); border: 1px solid var(--brd); border-radius: 10px; color: #fff; font-size: 14px; outline: none; }
        input:focus { border-color: var(--dim); }
        button { padding: 14px; background: var(--acc); color: #000; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:active { opacity: 0.7; transform: scale(0.98); }

        /* Аватарки */
        .avatar { width: 44px; height: 44px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--brd); flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* Список контактов */
        .contact { padding: 15px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #080808; }
        .contact:hover { background: #080808; }
        .contact.active { background: var(--surf); }

        /* Чат и сообщения */
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 14px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg.mine { align-self: flex-end; background: var(--acc); color: #000; border-bottom-right-radius: 2px; }
        .msg.theirs { align-self: flex-start; background: var(--surf); border: 1px solid var(--brd); border-bottom-left-radius: 2px; }

        /* Модальные окна */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-card { background: var(--surf); padding: 30px; border-radius: 20px; width: 90%; max-width: 360px; text-align: center; border: 1px solid var(--brd); }

        .lang-btn { position: absolute; top: 20px; right: 20px; color: var(--dim); cursor: pointer; font-size: 12px; font-weight: 600; z-index: 2000; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .main { display: none; position: fixed; inset: 0; z-index: 100; }
            .main.active { display: flex; }
        }
    </style>
</head>
<body>

    <div class="lang-btn" onclick="toggleLang()">EN / RU</div>

    <section id="auth-screen" class="screen">
        <div class="auth-box">
            <h1 style="margin-bottom: 25px; letter-spacing: 4px; font-weight: 400;">DASSGER</h1>
            <input type="text" id="reg-nick" placeholder="Enter nickname..." style="margin-bottom: 15px;">
            <button onclick="createAccount()" style="width: 100%" id="btn-start">Create Account</button>
        </div>
    </section>

    <section id="app-screen" class="screen">
        <div class="container">
            <aside class="sidebar">
                <div style="padding: 20px; border-bottom: 1px solid var(--brd);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; cursor: pointer;" onclick="openSettings()">
                        <div class="avatar" id="my-av"></div>
                        <span id="my-name" style="font-weight: 600;"></span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="target-id" placeholder="Partner ID" style="flex: 1;">
                        <button onclick="connectToPeer()" style="width: 50px;">+</button>
                    </div>
                </div>
                <div id="contacts-list" style="overflow-y: auto; flex: 1;"></div>
            </aside>

            <main class="main" id="chat-ui">
                <header style="padding: 15px 20px; border-bottom: 1px solid var(--brd); display: flex; align-items: center; gap: 12px;">
                    <button onclick="closeChat()" style="background:none; color:#fff; display:none; padding: 0 10px;" id="back-btn">←</button>
                    <div class="avatar" id="chat-av" style="width:32px; height:32px;"></div>
                    <span id="chat-name" style="font-weight: 600; font-size: 14px;">Select chat</span>
                </header>
                <div class="messages" id="msg-box"></div>
                <footer style="padding: 20px; display: flex; gap: 10px; background: #000;">
                    <input type="text" id="msg-input" placeholder="Your message..." style="flex: 1;">
                    <button onclick="sendMsg()" id="btn-send" style="width: 80px;">Send</button>
                </footer>
            </main>
        </div>
    </section>

    <div id="settings-modal" class="modal">
        <div class="modal-card">
            <h2 id="st-title" style="margin-bottom: 25px; font-weight: 400;">Settings</h2>
            <div class="avatar" id="st-av-prev" style="width: 90px; height: 90px; margin: 0 auto 15px; cursor: pointer; font-size: 24px;" onclick="document.getElementById('file-in').click()"></div>
            <input type="file" id="file-in" hidden onchange="handleFile(this)" accept="image/*">
            <input type="text" id="st-name-in" style="margin-bottom: 10px;">
            <div id="st-id-box" onclick="copyId()" style="font-size: 11px; color: var(--dim); margin-bottom: 20px; cursor: pointer; background: #000; padding: 12px; border-radius: 8px; word-break: break-all;"></div>
            <button onclick="saveSettings()" style="width: 100%; margin-bottom: 10px;" id="btn-save">Save Settings</button>
            <button onclick="deleteAccount()" style="background:none; color:var(--danger); width:100%; font-size: 13px;" id="btn-del">Delete All Data</button>
            <button onclick="closeSettings()" style="background:none; color:var(--dim); width:100%; margin-top: 10px; font-size: 13px;" id="btn-cls">Cancel</button>
        </div>
    </div>

    <script>
        const i18n = {
            en: { start: "Create Account", send: "Send", save: "Save Settings", del: "Delete All Data", cls: "Cancel", sel: "Select chat", conf: "Wipe all data?", settings: "Settings", nick: "Enter nickname...", msg: "Your message...", target: "Partner ID" },
            ru: { start: "Создать аккаунт", send: "ОК", save: "Сохранить", del: "Удалить все данные", cls: "Отмена", sel: "Выберите чат", conf: "Стереть все данные?", settings: "Настройки", nick: "Введите ник...", msg: "Сообщение...", target: "ID собеседника" }
        };

        let lang = localStorage.getItem('dg_lang') || 'en';
        let profile = JSON.parse(localStorage.getItem('dg_profile'));
        let history = JSON.parse(localStorage.getItem('dg_history')) || {};
        let peer, conn, activeId = null;

        function updateLang() {
            const t = i18n[lang];
            document.getElementById('btn-start').innerText = t.start;
            document.getElementById('reg-nick').placeholder = t.nick;
            document.getElementById('btn-send').innerText = t.send;
            document.getElementById('btn-save').innerText = t.save;
            document.getElementById('btn-del').innerText = t.del;
            document.getElementById('btn-cls').innerText = t.cls;
            document.getElementById('st-title').innerText = t.settings;
            document.getElementById('msg-input').placeholder = t.msg;
            document.getElementById('target-id').placeholder = t.target;
            if(!activeId) document.getElementById('chat-name').innerText = t.sel;
        }

        function toggleLang() { lang = lang === 'en' ? 'ru' : 'en'; localStorage.setItem('dg_lang', lang); updateLang(); }

        window.onload = () => {
            updateLang();
            if(profile) {
                document.getElementById('app-screen').classList.add('active');
                initPeer();
            } else {
                document.getElementById('auth-screen').classList.add('active');
            }
        };

        function createAccount() {
            const nick = document.getElementById('reg-nick').value.trim();
            if(!nick) return;
            const id = 'dg-' + Math.random().toString(36).substr(2, 6);
            profile = { id, name: nick, av: null };
            localStorage.setItem('dg_profile', JSON.stringify(profile));
            window.location.reload();
        }

        function initPeer() {
            peer = new Peer(profile.id);
            peer.on('open', () => { renderMyProfile(); renderContacts(); });
            peer.on('connection', c => { conn = c; setupConnection(); });
        }

        function setupConnection() {
            conn.on('open', () => {
                activeId = conn.peer;
                if(!history[activeId]) history[activeId] = { name: conn.metadata?.name || activeId, av: conn.metadata?.av, msgs: [] };
                openChat(activeId);
            });
            conn.on('data', data => {
                if(data.type === 'msg') {
                    if(!history[conn.peer]) history[conn.peer] = { name: conn.metadata?.name || conn.peer, av: conn.metadata?.av, msgs: [] };
                    history[conn.peer].msgs.push({ side: 'theirs', text: data.text });
                    localStorage.setItem('dg_history', JSON.stringify(history));
                }
                renderContacts();
                if(activeId === conn.peer) renderMsgs();
            });
        }

        function openChat(id) {
            activeId = id;
            document.getElementById('chat-ui').classList.add('active');
            document.getElementById('chat-name').innerText = history[id].name;
            const avImg = history[id].av ? `<img src="${history[id].av}">` : history[id].name[0].toUpperCase();
            document.getElementById('chat-av').innerHTML = avImg;
            if(window.innerWidth < 768) document.getElementById('back-btn').style.display = 'block';
            renderMsgs();
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !activeId) return;
            
            if(conn && conn.open) conn.send({ type: 'msg', text: text });
            
            history[activeId].msgs.push({ side: 'mine', text: text });
            localStorage.setItem('dg_history', JSON.stringify(history));
            input.value = '';
            renderMsgs();
        }

        function renderMsgs() {
            const box = document.getElementById('msg-box');
            box.innerHTML = history[activeId].msgs.map(m => `<div class="msg ${m.side}">${m.text}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }

        function renderContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = Object.keys(history).map(id => `
                <div class="contact ${activeId === id ? 'active' : ''}" onclick="startChat('${id}')">
                    <div class="avatar">${history[id].av ? `<img src="${history[id].av}">` : history[id].name[0].toUpperCase()}</div>
                    <span style="font-size: 14px; font-weight: 600;">${history[id].name}</span>
                </div>
            `).join('');
        }

        function startChat(id) {
            conn = peer.connect(id, { metadata: { name: profile.name, av: profile.av } });
            setupConnection();
        }

        function connectToPeer() {
            const id = document.getElementById('target-id').value.trim();
            if(id && id !== profile.id) startChat(id);
        }

        function renderMyProfile() {
            document.getElementById('my-name').innerText = profile.name;
            document.getElementById('my-av').innerHTML = profile.av ? `<img src="${profile.av}">` : profile.name[0].toUpperCase();
        }

        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
            document.getElementById('st-name-in').value = profile.name;
            document.getElementById('st-id-box').innerText = "ID: " + profile.id;
            document.getElementById('st-av-prev').innerHTML = profile.av ? `<img src="${profile.av}">` : profile.name[0].toUpperCase();
        }

        function handleFile(input) {
            const reader = new FileReader();
            reader.onload = e => {
                profile.av = e.target.result;
                document.getElementById('st-av-prev').innerHTML = `<img src="${profile.av}">`;
            };
            if(input.files[0]) reader.readAsDataURL(input.files[0]);
        }

        function saveSettings() {
            profile.name = document.getElementById('st-name-in').value;
            localStorage.setItem('dg_profile', JSON.stringify(profile));
            renderMyProfile();
            closeSettings();
        }

        function deleteAccount() {
            if(confirm(i18n[lang].conf)) { localStorage.clear(); window.location.reload(); }
        }

        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function closeChat() { document.getElementById('chat-ui').classList.remove('active'); activeId = null; }
        function copyId() { navigator.clipboard.writeText(profile.id); alert(i18n[lang].copied || 'Copied!'); }

        document.getElementById('msg-input').onkeydown = e => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
