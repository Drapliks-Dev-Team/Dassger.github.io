<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dassger Ultra Minimal</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: #1a1a1a;
            --accent: #ffffff;
            --text: #ffffff;
            --text-dim: #666666;
            --danger: #ff4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Управление экранами */
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s; }
        .screen.active { display: flex; opacity: 1; }

        /* Экран входа */
        #auth-screen { align-items: center; justify-content: center; background: var(--bg); z-index: 1000; }
        .auth-box { width: 100%; max-width: 320px; text-align: center; }

        /* Основной интерфейс */
        .container { display: flex; height: 100vh; width: 100%; }
        .sidebar { width: 320px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg); }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        /* Элементы UI */
        input { width: 100%; padding: 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: #fff; font-size: 14px; margin-bottom: 10px; transition: 0.2s; }
        input:focus { border-color: var(--text-dim); }
        
        button { width: 100%; padding: 14px; background: var(--accent); color: #000; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px; transition: 0.2s; }
        button:active { transform: scale(0.98); }

        .avatar { width: 44px; height: 44px; border-radius: 50%; background: #111; display: flex; align-items: center; justify-content: center; font-size: 16px; overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* Список контактов */
        .list-item { padding: 15px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #080808; transition: 0.2s; }
        .list-item:hover { background: #080808; }
        .list-item.active { background: var(--surface); }

        /* Чат */
        .messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 14px; font-size: 14px; line-height: 1.5; }
        .msg.mine { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 2px; }
        .msg.theirs { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 2px; }

        /* Модальное окно */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--surface); padding: 40px; border-radius: 20px; width: 90%; max-width: 360px; border: 1px solid var(--border); text-align: center; }

        .lang-toggle { position: absolute; top: 25px; right: 25px; font-size: 11px; cursor: pointer; color: var(--text-dim); letter-spacing: 1px; z-index: 3000; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .main { display: none; position: fixed; inset: 0; z-index: 100; }
            .main.active { display: flex; }
            .back-btn { display: block !important; }
        }
    </style>
</head>
<body>

    <div class="lang-toggle" onclick="toggleLang()">EN / RU</div>

    <div id="auth-screen" class="screen">
        <div class="auth-box">
            <h1 style="margin-bottom: 30px; font-weight: 300; letter-spacing: 5px;">DASSGER</h1>
            <input type="text" id="reg-nick" placeholder="Nickname">
            <button onclick="createAccount()" id="btn-create">Start</button>
        </div>
    </div>

    <div id="app-screen" class="screen">
        <div class="container">
            <aside class="sidebar">
                <div style="padding: 25px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; cursor: pointer;" onclick="openSettings()">
                        <div class="avatar" id="my-av"></div>
                        <span id="my-name" style="font-weight: 600; font-size: 14px;"></span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="target-id" placeholder="Friend ID" style="margin:0;">
                        <button onclick="connectToPeer()" style="width: 50px;">+</button>
                    </div>
                </div>
                <div id="contact-list" style="overflow-y: auto; flex: 1;"></div>
            </aside>

            <main class="main" id="main-ui">
                <div style="padding: 18px 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: var(--bg);">
                    <span onclick="closeChat()" style="cursor:pointer; display:none; font-size: 20px;" id="mobile-back" class="back-btn">←</span>
                    <div class="avatar" id="chat-av" style="width:32px; height:32px;"></div>
                    <span id="chat-name" style="font-size: 14px; font-weight: 600;">Select chat</span>
                </div>
                <div class="messages" id="msg-box"></div>
                <div style="padding: 25px; display: flex; gap: 10px; background: var(--bg);">
                    <input type="text" id="msg-input" placeholder="Type..." style="margin:0;">
                    <button onclick="sendMsg()" style="width: 80px;" id="btn-send">Send</button>
                </div>
            </main>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3 id="set-title" style="margin-bottom: 25px; font-weight: 400;">Settings</h3>
            <div class="avatar" id="set-av-preview" style="width: 100px; height: 100px; margin: 0 auto 15px; font-size: 30px; cursor: pointer;" onclick="document.getElementById('file-in').click()"></div>
            <p style="font-size: 11px; color: var(--text-dim); margin-bottom: 20px;" id="photo-hint">Tap to change photo</p>
            <input type="file" id="file-in" hidden onchange="handleFile(this)" accept="image/*">
            <input type="text" id="set-name-in">
            <div id="my-id-display" onclick="copyId()" style="font-size: 10px; color: var(--text-dim); margin: 15px 0; padding: 12px; background: #000; border-radius: 8px; cursor: pointer; word-break: break-all;"></div>
            <button onclick="saveSettings()" id="btn-save">Save</button>
            <button onclick="deleteAccount()" style="background: none; color: var(--danger); margin-top: 20px; font-size: 12px;" id="btn-delete">Wipe Account Data</button>
            <button onclick="closeSettings()" style="background: none; color: var(--text-dim); margin-top: 10px; font-size: 12px;" id="btn-close">Cancel</button>
        </div>
    </div>

    <script>
        const i18n = {
            en: {
                create: "Start", nick: "Nickname", photoHint: "Tap to change photo", save: "Save",
                delete: "Wipe Account Data", close: "Cancel", select: "Select chat", send: "Send",
                copied: "ID Copied!", confirm: "Permanent action: Delete all data and messages?",
                settings: "Settings", idLabel: "Your ID (click to copy):", type: "Type..."
            },
            ru: {
                create: "Войти", nick: "Никнейм", photoHint: "Нажми для смены фото", save: "Сохранить",
                delete: "Удалить все данные", close: "Отмена", select: "Выберите чат", send: "ОК",
                copied: "ID скопирован!", confirm: "Внимание: Это удалит аккаунт и все переписки навсегда.",
                settings: "Настройки", idLabel: "Ваш ID (нажми для копии):", type: "Сообщение..."
            }
        };

        let lang = localStorage.getItem('dg_lang') || 'en';
        let profile = JSON.parse(localStorage.getItem('dg_profile'));
        let history = JSON.parse(localStorage.getItem('dg_history')) || {};
        let peer, conn, activeId = null;

        function updateLang() {
            const t = i18n[lang];
            document.getElementById('btn-create').innerText = t.create;
            document.getElementById('reg-nick').placeholder = t.nick;
            document.getElementById('photo-hint').innerText = t.photoHint;
            document.getElementById('btn-save').innerText = t.save;
            document.getElementById('btn-delete').innerText = t.delete;
            document.getElementById('btn-close').innerText = t.close;
            document.getElementById('btn-send').innerText = t.send;
            document.getElementById('set-title').innerText = t.settings;
            document.getElementById('msg-input').placeholder = t.type;
            if(!activeId) document.getElementById('chat-name').innerText = t.select;
        }

        function toggleLang() {
            lang = lang === 'en' ? 'ru' : 'en';
            localStorage.setItem('dg_lang', lang);
            updateLang();
        }

        window.onload = () => {
            updateLang();
            if(profile) {
                document.getElementById('app-screen').classList.add('active');
                initPeer();
            } else {
                document.getElementById('auth-screen').classList.add('active');
            }
        }

        function createAccount() {
            const nick = document.getElementById('reg-nick').value.trim();
            if(!nick) return;
            const id = 'dg-' + Math.random().toString(36).substr(2, 6);
            profile = { id, name: nick, av: null };
            localStorage.setItem('dg_profile', JSON.stringify(profile));
            window.location.reload();
        }

        function initPeer() {
            peer = new Peer(profile.id);
            peer.on('open', () => { updateUI(); renderContacts(); });
            peer.on('connection', c => { 
                conn = c; 
                setupConn(); 
            });
            peer.on('error', () => alert('Connection error or peer offline'));
        }

        function setupConn() {
            conn.on('open', () => {
                activeId = conn.peer;
                if(!history[activeId]) history[activeId] = { name: conn.metadata?.name || activeId, av: conn.metadata?.av, msgs: [] };
                openChat(activeId);
            });
            conn.on('data', data => {
                if(data.type === 'msg') {
                    if(!history[conn.peer]) history[conn.peer] = { name: conn.metadata?.name || conn.peer, msgs: [] };
                    pushMsg(conn.peer, 'theirs', data.text);
                }
                renderContacts();
                if(activeId === conn.peer) renderMsgs();
            });
        }

        function openChat(id) {
            activeId = id;
            document.getElementById('main-ui').classList.add('active');
            document.getElementById('chat-name').innerText = history[id].name;
            const chatAv = document.getElementById('chat-avatar-view') || document.getElementById('chat-av');
            chatAv.innerHTML = history[id].av ? `<img src="${history[id].av}">` : history[id].name[0].toUpperCase();
            renderMsgs();
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value || !conn) return;
            conn.send({ type: 'msg', text: input.value });
            pushMsg(activeId, 'mine', input.value);
            input.value = '';
            renderMsgs();
        }

        function pushMsg(id, side, text) {
            if(!history[id].msgs) history[id].msgs = [];
            history[id].msgs.push({ side, text });
            localStorage.setItem('dg_history', JSON.stringify(history));
        }

        function renderMsgs() {
            const box = document.getElementById('msg-box');
            box.innerHTML = history[activeId].msgs.map(m => `<div class="msg ${m.side}">${m.text}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }

        function renderContacts() {
            const list = document.getElementById('contact-list');
            list.innerHTML = Object.keys(history).map(id => `
                <div class="list-item ${activeId === id ? 'active' : ''}" onclick="startConnect('${id}')">
                    <div class="avatar">${history[id].av ? `<img src="${history[id].av}">` : history[id].name[0].toUpperCase()}</div>
                    <span style="font-size: 14px;">${history[id].name}</span>
                </div>
            `).join('');
        }

        function startConnect(id) {
            conn = peer.connect(id, { metadata: { name: profile.name, av: profile.av } });
            setupConn();
        }

        function connectToPeer() {
            const id = document.getElementById('target-id').value.trim();
            if(id && id !== profile.id) startConnect(id);
        }

        function updateUI() {
            document.getElementById('my-name').innerText = profile.name;
            document.getElementById('my-av').innerHTML = profile.av ? `<img src="${profile.av}">` : profile.name[0].toUpperCase();
        }

        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
            document.getElementById('set-name-in').value = profile.name;
            document.getElementById('my-id-display').innerText = profile.id;
            document.getElementById('set-av-preview').innerHTML = profile.av ? `<img src="${profile.av}">` : profile.name[0].toUpperCase();
        }

        function saveSettings() {
            profile.name = document.getElementById('set-name-in').value;
            localStorage.setItem('dg_profile', JSON.stringify(profile));
            updateUI();
            closeSettings();
        }

        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                profile.av = e.target.result;
                document.getElementById('set-av-preview').innerHTML = `<img src="${profile.av}">`;
            };
            reader.readAsDataURL(file);
        }

        function deleteAccount() {
            if(confirm(i18n[lang].confirm)) {
                localStorage.clear();
                window.location.reload();
            }
        }

        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function closeChat() { document.getElementById('main-ui').classList.remove('active'); activeId = null; }
        function copyId() { 
            navigator.clipboard.writeText(profile.id); 
            alert(i18n[lang].copied); 
        }

        // Поддержка Enter
        document.getElementById('msg-input').addEventListener('keypress', e => {
            if(e.key === 'Enter') sendMsg();
        });
    </script>
</body>
</html>
