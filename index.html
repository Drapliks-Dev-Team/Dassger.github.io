<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dassger Ultra | Next-Gen P2P</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030303;
            --card: rgba(20, 20, 20, 0.75);
            --accent: #ffffff;
            --accent-glow: rgba(255, 255, 255, 0.2);
            --text: #ffffff;
            --text-dim: #777;
            --danger: #ff3b3b;
            --glass: blur(20px) saturate(160%);
            --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% -20%, #222 0%, #030303 85%);
            color: var(--text); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
        }

        /* --- UI UTILS --- */
        .glass { background: var(--card); backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); border: 1px solid rgba(255,255,255,0.1); }
        .hover-scale { transition: var(--transition); }
        .hover-scale:active { transform: scale(0.96); opacity: 0.8; }

        /* --- AUTH SCREEN --- */
        #auth-screen { 
            position: fixed; inset: 0; background: var(--bg); z-index: 9999; 
            display: flex; align-items: center; justify-content: center;
        }

        .auth-card { 
            width: 90%; max-width: 400px; padding: 45px; border-radius: 35px; text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }

        .logo { font-size: 52px; font-weight: 800; letter-spacing: -3px; margin-bottom: 8px; background: linear-gradient(to bottom, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- MAIN LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100vh; padding: 25px; gap: 20px; }
        
        @media (max-width: 850px) { 
            .app-container { padding: 0; gap: 0; }
            .sidebar { border-radius: 0 !important; width: 100% !important; }
            .main-chat { border-radius: 0 !important; position: absolute !important; inset: 0; transform: translateX(100%); z-index: 100; }
            .main-chat.active { transform: translateX(0); }
            .back-btn { display: block !important; }
        }

        .sidebar { width: 380px; display: flex; flex-direction: column; border-radius: 30px; overflow: hidden; }
        .main-chat { flex: 1; display: flex; flex-direction: column; border-radius: 30px; overflow: hidden; position: relative; transition: var(--transition); }

        /* --- COMPONENTS --- */
        input { 
            width: 100%; padding: 18px; margin: 10px 0; background: rgba(0,0,0,0.4); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; color: #fff; 
            outline: none; transition: var(--transition); font-size: 15px;
        }
        input:focus { border-color: var(--accent); background: rgba(0,0,0,0.6); box-shadow: 0 0 25px var(--accent-glow); }

        button { 
            width: 100%; padding: 18px; background: var(--accent); color: #000; 
            border: none; border-radius: 20px; font-weight: 800; cursor: pointer;
            box-shadow: 0 8px 20px rgba(255,255,255,0.15);
        }

        .contact-item { 
            padding: 16px 22px; margin: 0 12px 10px; border-radius: 22px; cursor: pointer; 
            display: flex; align-items: center; gap: 16px; transition: var(--transition);
        }
        .contact-item:hover { background: rgba(255,255,255,0.06); }
        .contact-item.active { background: rgba(255,255,255,0.12); border-left: 4px solid #fff; }

        .avatar { 
            width: 50px; height: 50px; border-radius: 18px; background: linear-gradient(135deg, #444, #111);
            display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.12); overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 14px; }
        .bubble { 
            max-width: 75%; padding: 15px 20px; border-radius: 24px; font-size: 15px; line-height: 1.5;
            animation: msgShow 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        @keyframes msgShow { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .mine { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .theirs { align-self: flex-start; background: rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }

        .lang-switch { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; }
        .lang-pill { padding: 8px 20px; border-radius: 14px; font-size: 13px; cursor: pointer; background: rgba(255,255,255,0.07); border: 1px solid transparent; }
        .lang-pill.active { background: #fff; color: #000; font-weight: 700; }

        /* --- MODAL --- */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; 
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px);
        }
        .modal-card { width: 92%; max-width: 420px; padding: 35px; border-radius: 35px; text-align: center; border: 1px solid rgba(255,255,255,0.15); }

        .back-btn { display: none; background: none; border: none; color: white; font-size: 26px; padding: 0 15px; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card glass">
            <div class="logo">Dassger</div>
            <div class="lang-switch">
                <div class="lang-pill active" data-l="ru">RU</div>
                <div class="lang-pill" data-l="en">EN</div>
            </div>
            <p id="auth-desc" style="color: var(--text-dim); margin-bottom: 25px; font-size: 14px; line-height: 1.4;"></p>
            <input type="text" id="reg-nickname" spellcheck="false" autocomplete="off">
            <button id="btn-create" class="hover-scale"></button>
        </div>
    </div>

    <div id="modal-settings" class="modal">
        <div class="modal-card glass">
            <h2 id="set-title" style="margin-bottom: 20px; font-size: 24px;"></h2>
            <div class="avatar" id="set-avatar-preview" style="width:110px; height:110px; margin: 0 auto 25px; border-radius: 35px; font-size: 36px;"></div>
            <input type="file" id="file-avatar" hidden accept="image/*">
            <button class="hover-scale" id="btn-change-photo" style="background: rgba(255,255,255,0.08); color: #fff; margin-bottom: 12px; font-size: 14px;"></button>
            <input type="text" id="set-nickname-input">
            <p id="display-my-id" style="font-size: 11px; color: var(--text-dim); margin: 15px 0; background: rgba(0,0,0,0.4); padding: 18px; border-radius: 22px; cursor: pointer; border: 1px dashed rgba(255,255,255,0.15); line-height: 1.5;"></p>
            <button id="btn-save" class="hover-scale" style="margin-bottom: 12px;"></button>
            <button id="btn-nuke" class="hover-scale" style="background: var(--danger); color: white;"></button>
            <button id="btn-cancel" style="background:none; color: var(--text-dim); margin-top: 15px; box-shadow: none; font-size: 14px;"></button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar glass">
            <div style="padding: 30px;">
                <div style="display: flex; align-items: center; gap: 18px; margin-bottom: 30px; cursor: pointer;" id="trigger-settings">
                    <div class="avatar" id="my-avatar"></div>
                    <div style="flex:1">
                        <b id="my-name-label" style="font-size: 19px; display: block; letter-spacing: -0.5px;"></b>
                        <span id="my-status" style="font-size: 11px; color: var(--text-dim); font-weight: 600;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="conn-id" style="margin:0; font-size: 14px;">
                    <button id="btn-add" class="hover-scale" style="width: 65px; box-shadow: none;">+</button>
                </div>
            </div>
            <div id="contact-list" style="flex:1; overflow-y:auto; padding-bottom: 30px;"></div>
        </aside>

        <main class="main-chat glass" id="chat-window">
            <div style="padding: 20px 30px; display: flex; align-items: center; gap: 18px; border-bottom: 1px solid rgba(255,255,255,0.06);">
                <button class="back-btn" id="trigger-back">←</button>
                <div class="avatar" id="chat-avatar" style="width:44px; height:44px; border-radius: 14px;"></div>
                <div>
                    <b id="chat-name" style="font-size: 17px; letter-spacing: -0.3px;"></b>
                    <div id="chat-id-label" style="font-size: 10px; color: var(--text-dim); font-weight: 600;"></div>
                </div>
            </div>
            <div class="messages" id="msg-box"></div>
            <div style="padding: 25px 30px; display: flex; gap: 15px; background: rgba(0,0,0,0.25);">
                <input type="text" id="msg-input" style="margin:0;" autocomplete="off">
                <button id="btn-send" class="hover-scale" style="width: 100px;"></button>
            </div>
        </main>
    </div>

    <script>
        const i18n = {
            ru: {
                authDesc: "Ваш первый никнейм создаст вечный зашифрованный ID",
                regNick: "Ваш никнейм...",
                btnCreate: "Создать аккаунт",
                setTitle: "Профиль",
                btnPhoto: "Сменить фото",
                setNick: "Новое имя",
                btnSave: "Сохранить",
                btnNuke: "Удалить всё",
                btnCancel: "Отмена",
                myStatus: "В сети • Настройки",
                friendId: "ID друга...",
                selectChat: "Выберите контакт",
                btnSend: "ОК",
                copy: "Нажмите, чтобы скопировать ваш ID",
                confirm: "Удалить аккаунт и историю навсегда?",
                copied: "ID скопирован!",
                online: "В сети"
            },
            en: {
                authDesc: "Your first nickname creates a permanent encrypted ID",
                regNick: "Username...",
                btnCreate: "Create Account",
                setTitle: "Profile",
                btnPhoto: "Change Avatar",
                setNick: "New name",
                btnSave: "Save Changes",
                btnNuke: "Wipe Account",
                btnCancel: "Cancel",
                myStatus: "Online • Settings",
                friendId: "Friend's ID...",
                selectChat: "Select a chat",
                btnSend: "Send",
                copy: "Click to copy your ID",
                confirm: "Wipe all data and history forever?",
                copied: "ID Copied!",
                online: "Online"
            }
        };

        let lang = localStorage.getItem('dg_lang') || 'ru';
        let peer, conn, activeId = null;
        let profile = JSON.parse(localStorage.getItem('dg_v10_profile'));
        let history = JSON.parse(localStorage.getItem('dg_v10_history')) || {};

        function updateLang() {
            const t = i18n[lang];
            document.querySelectorAll('.lang-pill').forEach(p => p.classList.toggle('active', p.dataset.l === lang));
            document.getElementById('auth-desc').innerText = t.authDesc;
            document.getElementById('reg-nickname').placeholder = t.regNick;
            document.getElementById('btn-create').innerText = t.btnCreate;
            document.getElementById('set-title').innerText = t.setTitle;
            document.getElementById('btn-change-photo').innerText = t.btnPhoto;
            document.getElementById('set-nickname-input').placeholder = t.setNick;
            document.getElementById('btn-save').innerText = t.btnSave;
            document.getElementById('btn-nuke').innerText = t.btnNuke;
            document.getElementById('btn-cancel').innerText = t.btnCancel;
            document.getElementById('my-status').innerText = t.myStatus;
            document.getElementById('conn-id').placeholder = t.friendId;
            document.getElementById('btn-send').innerText = t.btnSend;
            if(!activeId) document.getElementById('chat-name').innerText = t.selectChat;
        }

        function initPeer(id) {
            peer = new Peer(id);
            peer.on('open', () => { renderSidebar(); renderContacts(); });
            peer.on('connection', (c) => { conn = c; handleConn(); });
            peer.on('error', (err) => { if(err.type === 'peer-unavailable') alert("User is offline"); });
        }

        function handleConn() {
            conn.on('open', () => {
                activeId = conn.peer;
                if(!history[activeId]) history[activeId] = { name: conn.metadata?.name || activeId, av: conn.metadata?.av, msgs: [] };
                openChat();
            });
            conn.on('data', (d) => {
                if(d.type === 'meta') { 
                    history[conn.peer].name = d.name; 
                    history[conn.peer].av = d.av; 
                    if(activeId === conn.peer) updateHeader();
                } else {
                    pushMsg(conn.peer, 'theirs', d.content);
                }
                if(activeId === conn.peer) renderMsgs();
                renderContacts();
            });
        }

        function openChat() {
            document.getElementById('chat-window').classList.add('active');
            updateHeader();
            renderMsgs();
        }

        function updateHeader() {
            const u = history[activeId];
            document.getElementById('chat-name').innerText = u.name;
            document.getElementById('chat-id-label').innerText = i18n[lang].online + " • " + activeId;
            drawAv('chat-avatar', u.av, u.name);
        }

        function pushMsg(pid, side, content) {
            if(!history[pid]) history[pid] = { name: pid, msgs: [] };
            history[pid].msgs.push({ side, content });
            localStorage.setItem('dg_v10_history', JSON.stringify(history));
        }

        function renderMsgs() {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            (history[activeId]?.msgs || []).forEach(m => {
                const d = document.createElement('div');
                d.className = `bubble ${m.side}`;
                d.innerText = m.content;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function renderContacts() {
            const list = document.getElementById('contact-list');
            list.innerHTML = "";
            Object.keys(history).forEach(id => {
                const u = history[id];
                const d = document.createElement('div');
                d.className = `contact-item ${activeId === id ? 'active' : ''}`;
                d.onclick = () => { 
                    activeId = id; 
                    conn = peer.connect(id, {metadata:{name:profile.name, av:profile.av}}); 
                    handleConn(); 
                };
                d.innerHTML = `<div class="avatar">${u.av ? '<img src="'+u.av+'">' : u.name[0].toUpperCase()}</div><b>${u.name}</b>`;
                list.appendChild(d);
            });
        }

        function renderSidebar() {
            document.getElementById('my-name-label').innerText = profile.name;
            drawAv('my-avatar', profile.av, profile.name);
        }

        function drawAv(elId, src, nick) {
            const el = document.getElementById(elId);
            if(src) el.innerHTML = `<img src="${src}">`;
            else el.innerText = nick ? nick[0].toUpperCase() : '?';
        }

        // --- EVENTS ---
        document.querySelectorAll('.lang-pill').forEach(p => {
            p.onclick = () => { lang = p.dataset.l; localStorage.setItem('dg_lang', lang); updateLang(); };
        });

        document.getElementById('btn-create').onclick = () => {
            const nick = document.getElementById('reg-nickname').value.trim();
            if(!nick) return;
            const id = "dg_" + nick.toLowerCase().replace(/[^a-z]/g, "") + "_" + Math.floor(Math.random()*9999);
            profile = { id, name: nick, av: null };
            localStorage.setItem('dg_v10_profile', JSON.stringify(profile));
            location.reload();
        };

        document.getElementById('btn-add').onclick = () => {
            const id = document.getElementById('conn-id').value.trim();
            if(!id || id === profile.id) return;
            conn = peer.connect(id, {metadata:{name:profile.name, av:profile.av}});
            handleConn();
        };

        document.getElementById('btn-send').onclick = () => {
            const i = document.getElementById('msg-input');
            if(!i.value.trim() || !conn) return;
            conn.send({ content: i.value });
            pushMsg(activeId, 'mine', i.value);
            i.value = ""; renderMsgs();
        };

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('btn-send').click(); };

        document.getElementById('trigger-settings').onclick = () => {
            document.getElementById('modal-settings').style.display = 'flex';
            document.getElementById('set-nickname-input').value = profile.name;
            document.getElementById('display-my-id').innerText = i18n[lang].copy + "\n" + profile.id;
            drawAv('set-avatar-preview', profile.av, profile.name);
        };

        document.getElementById('display-my-id').onclick = () => {
            navigator.clipboard.writeText(profile.id);
            alert(i18n[lang].copied);
        };

        document.getElementById('btn-save').onclick = () => {
            profile.name = document.getElementById('set-nickname-input').value.trim() || profile.name;
            localStorage.setItem('dg_v10_profile', JSON.stringify(profile));
            renderSidebar(); 
            document.getElementById('modal-settings').style.display = 'none';
            if(conn) conn.send({type:'meta', name:profile.name, av:profile.av});
        };

        document.getElementById('btn-nuke').onclick = () => {
            if(confirm(i18n[lang].confirm)) { localStorage.clear(); location.reload(); }
        };

        document.getElementById('btn-cancel').onclick = () => document.getElementById('modal-settings').style.display = 'none';
        document.getElementById('trigger-back').onclick = () => { document.getElementById('chat-window').classList.remove('active'); activeId = null; };

        document.getElementById('file-avatar').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => { profile.av = ev.target.result; drawAv('set-avatar-preview', profile.av, profile.name); };
            r.readAsDataURL(e.target.files[0]);
        };

        if(profile) { document.getElementById('auth-screen').classList.add('hidden'); initPeer(profile.id); }
        updateLang();
    </script>
</body>
</html>
