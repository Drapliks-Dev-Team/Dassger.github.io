<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dassger Ultra | Final v12.5</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030303;
            --card: rgba(25, 25, 25, 0.8);
            --accent: #ffffff;
            --text: #ffffff;
            --text-dim: #888;
            --glass: blur(25px) saturate(180%);
            --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% -20%, #333 0%, #030303 95%); 
            color: var(--text); 
            height: 100vh; 
            overflow: hidden; 
        }

        /* --- SCREEN CONTROL --- */
        .screen { position: fixed; inset: 0; display: none; opacity: 0; transition: opacity 0.5s ease; }
        .screen.active { display: flex; opacity: 1; }

        /* --- AUTH SCREEN --- */
        #screen-auth { align-items: center; justify-content: center; z-index: 1000; }
        .auth-card { 
            width: 90%; max-width: 400px; padding: 50px; border-radius: 45px; 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: var(--glass); text-align: center;
        }

        /* --- APP SCREEN --- */
        #screen-app { width: 100%; height: 100vh; padding: 20px; gap: 20px; }

        /* --- UI ELEMENTS --- */
        input { 
            width: 100%; padding: 20px; margin: 15px 0; background: rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; color: #fff; 
            outline: none; transition: var(--transition); font-size: 16px;
        }
        input:focus { border-color: var(--accent); background: rgba(0,0,0,0.8); }

        button { 
            width: 100%; padding: 20px; background: var(--accent); color: #000; 
            border: none; border-radius: 25px; font-weight: 800; cursor: pointer;
            box-shadow: 0 10px 30px rgba(255,255,255,0.1); transition: var(--transition);
        }
        button:active { transform: scale(0.95); }

        .avatar { 
            width: 60px; height: 60px; border-radius: 22px; background: linear-gradient(135deg, #444, #111);
            display: flex; align-items: center; justify-content: center; font-weight: 800;
            border: 1px solid rgba(255,255,255,0.1); overflow: hidden; position: relative;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* --- CHAT AREA --- */
        .sidebar { width: 380px; display: flex; flex-direction: column; border-radius: 40px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: var(--glass); }
        .main-chat { flex: 1; display: flex; flex-direction: column; border-radius: 40px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: var(--glass); overflow: hidden; }

        .messages { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .bubble { 
            max-width: 75%; padding: 16px 22px; border-radius: 26px; font-size: 15px; 
            animation: pop 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.28) both; 
        }
        @keyframes pop { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .mine { align-self: flex-end; background: #fff; color: #000; border-bottom-right-radius: 4px; }
        .theirs { align-self: flex-start; background: rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }

        .contact-item { padding: 20px; margin: 5px 15px; border-radius: 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.3s; }
        .contact-item:hover { background: rgba(255,255,255,0.05); }
        .contact-item.active { background: rgba(255,255,255,0.1); }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(30px); }
        .modal-card { width: 90%; max-width: 420px; padding: 40px; border-radius: 50px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }

        @media (max-width: 800px) {
            #screen-app { padding: 0; gap: 0; }
            .sidebar { width: 100%; border-radius: 0; border: none; }
            .main-chat { position: fixed; inset: 0; z-index: 100; border-radius: 0; transform: translateX(100%); transition: 0.5s; display: none; }
            .main-chat.active { transform: translateX(0); display: flex; }
        }
    </style>
</head>
<body>

    <section id="screen-auth" class="screen">
        <div class="auth-card">
            <h1 style="font-size: 50px; font-weight: 800; letter-spacing: -3px; margin-bottom: 10px;">Dassger</h1>
            <p style="color: var(--text-dim); margin-bottom: 30px;">Создайте свой защищенный ID</p>
            <input type="text" id="input-reg-nick" placeholder="Введите ваш никнейм...">
            <button id="btn-login-action">Создать аккаунт</button>
        </div>
    </section>

    <section id="screen-app" class="screen">
        <aside class="sidebar">
            <div style="padding: 35px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; cursor: pointer;" id="btn-open-settings">
                    <div class="avatar" id="my-avatar-view"></div>
                    <div>
                        <b id="my-name-view" style="font-size: 20px; display: block;"></b>
                        <span style="font-size: 11px; color: var(--text-dim);">Настройки профиля</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="input-target-id" placeholder="ID друга..." style="margin: 0; padding: 15px;">
                    <button id="btn-add-friend" style="width: 60px; padding: 0;">+</button>
                </div>
            </div>
            <div id="contacts-list" style="flex:1; overflow-y:auto;"></div>
        </aside>

        <main class="main-chat" id="chat-panel">
            <div style="padding: 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px;">
                <button id="btn-back" style="width: 40px; background: none; color: white; font-size: 24px; padding: 0; display: none;">←</button>
                <div class="avatar" id="chat-avatar-view" style="width: 45px; height: 45px;"></div>
                <b id="chat-name-view">Выберите чат</b>
            </div>
            <div class="messages" id="messages-box"></div>
            <div style="padding: 25px; background: rgba(0,0,0,0.2); display: flex; gap: 15px;">
                <input type="text" id="input-msg" placeholder="Сообщение..." style="margin: 0;">
                <button id="btn-send" style="width: 80px;">ОК</button>
            </div>
        </main>
    </section>

    <div id="modal-settings" class="modal">
        <div class="modal-card">
            <h2 style="margin-bottom: 25px;">Настройки</h2>
            <div class="avatar" id="set-av-preview" style="width: 120px; height: 120px; margin: 0 auto 20px; border-radius: 40px; font-size: 40px; cursor: pointer;">
                <input type="file" id="file-input" hidden accept="image/*">
            </div>
            <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 20px;">Нажми на фото, чтобы изменить</p>
            <input type="text" id="set-name-input">
            <div id="my-full-id" style="font-size: 10px; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 20px; margin: 15px 0; border: 1px dashed #444; cursor: pointer;"></div>
            <button id="btn-save-settings" style="margin-bottom: 10px;">Сохранить</button>
            <button id="btn-logout" style="background: #ff3b3b; color: white;">Выйти из аккаунта</button>
            <button id="btn-close-modal" style="background: none; color: #777; margin-top: 10px;">Закрыть</button>
        </div>
    </div>

    <script>
        // --- ДАННЫЕ ---
        let profile = JSON.parse(localStorage.getItem('dg_v12_profile'));
        let history = JSON.parse(localStorage.getItem('dg_v12_history')) || {};
        let peer, conn, activeId = null;

        // --- ИНИЦИАЛИЗАЦИЯ ---
        window.onload = () => {
            if (profile) {
                showScreen('screen-app');
                initPeer();
            } else {
                showScreen('screen-auth');
            }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- ПЕРСОНАЖ / ВХОД ---
        document.getElementById('btn-login-action').onclick = () => {
            const nick = document.getElementById('input-reg-nick').value.trim();
            if (nick.length < 2) return alert("Слишком короткий ник");
            
            const id = "dg_" + Math.random().toString(36).substr(2, 6) + "_" + nick.toLowerCase().replace(/[^a-z]/g, "");
            profile = { id, name: nick, av: null };
            localStorage.setItem('dg_v12_profile', JSON.stringify(profile));
            window.location.reload();
        };

        // --- PEERJS LOGIC ---
        function initPeer() {
            peer = new Peer(profile.id);
            
            peer.on('open', (id) => {
                updateUI();
                renderContacts();
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConn();
            });
        }

        function setupConn() {
            conn.on('open', () => {
                activeId = conn.peer;
                if (!history[activeId]) history[activeId] = { name: conn.metadata?.name || activeId, av: conn.metadata?.av, msgs: [] };
                openChat(activeId);
            });

            conn.on('data', (data) => {
                if (data.type === 'msg') {
                    pushMsg(conn.peer, 'theirs', data.text);
                } else if (data.type === 'meta') {
                    history[conn.peer].name = data.name;
                    history[conn.peer].av = data.av;
                }
                renderContacts();
                if (activeId === conn.peer) renderMsgs();
            });
        }

        // --- ЧАТЫ ---
        function openChat(id) {
            activeId = id;
            const chat = history[id];
            document.getElementById('chat-panel').classList.add('active');
            document.getElementById('chat-name-view').innerText = chat.name;
            drawAv('chat-avatar-view', chat.av, chat.name);
            renderMsgs();
            if (window.innerWidth < 800) document.getElementById('btn-back').style.display = 'block';
        }

        function pushMsg(id, side, text) {
            if (!history[id]) history[id] = { name: id, msgs: [] };
            history[id].msgs.push({ side, text });
            localStorage.setItem('dg_v12_history', JSON.stringify(history));
        }

        function renderMsgs() {
            const box = document.getElementById('messages-box');
            box.innerHTML = '';
            history[activeId].msgs.forEach(m => {
                const d = document.createElement('div');
                d.className = `bubble ${m.side}`;
                d.innerText = m.text;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function renderContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            Object.keys(history).forEach(id => {
                const item = history[id];
                const d = document.createElement('div');
                d.className = `contact-item ${activeId === id ? 'active' : ''}`;
                d.onclick = () => {
                    activeId = id;
                    conn = peer.connect(id, { metadata: { name: profile.name, av: profile.av } });
                    setupConn();
                };
                d.innerHTML = `<div class="avatar">${item.av ? `<img src="${item.av}">` : item.name[0].toUpperCase()}</div><b>${item.name}</b>`;
                list.appendChild(d);
            });
        }

        // --- ИНТЕРФЕЙС ---
        function updateUI() {
            document.getElementById('my-name-view').innerText = profile.name;
            drawAv('my-avatar-view', profile.av, profile.name);
        }

        function drawAv(elId, src, nick) {
            const el = document.getElementById(elId);
            if (src) el.innerHTML = `<img src="${src}">`;
            else el.innerText = nick ? nick[0].toUpperCase() : '?';
        }

        document.getElementById('btn-send').onclick = () => {
            const inp = document.getElementById('input-msg');
            if (!inp.value.trim() || !activeId) return;
            const text = inp.value;
            if (conn) conn.send({ type: 'msg', text });
            pushMsg(activeId, 'mine', text);
            inp.value = '';
            renderMsgs();
        };

        document.getElementById('btn-add-friend').onclick = () => {
            const id = document.getElementById('input-target-id').value.trim();
            if (!id || id === profile.id) return;
            conn = peer.connect(id, { metadata: { name: profile.name, av: profile.av } });
            setupConn();
        };

        // --- НАСТРОЙКИ ---
        document.getElementById('btn-open-settings').onclick = () => {
            document.getElementById('modal-settings').style.display = 'flex';
            document.getElementById('set-name-input').value = profile.name;
            document.getElementById('my-full-id').innerText = "Ваш ID (нажми чтобы скопировать):\n" + profile.id;
            drawAv('set-av-preview', profile.av, profile.name);
        };

        document.getElementById('set-av-preview').onclick = () => document.getElementById('file-input').click();

        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                profile.av = ev.target.result;
                drawAv('set-av-preview', profile.av, profile.name);
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('btn-save-settings').onclick = () => {
            profile.name = document.getElementById('set-name-input').value;
            localStorage.setItem('dg_v12_profile', JSON.stringify(profile));
            updateUI();
            document.getElementById('modal-settings').style.display = 'none';
        };

        document.getElementById('btn-logout').onclick = () => {
            if (confirm("Удалить аккаунт?")) {
                localStorage.clear();
                window.location.reload();
            }
        };

        document.getElementById('btn-close-modal').onclick = () => document.getElementById('modal-settings').style.display = 'none';
        document.getElementById('btn-back').onclick = () => document.getElementById('chat-panel').classList.remove('active');
        document.getElementById('my-full-id').onclick = () => {
            navigator.clipboard.writeText(profile.id);
            alert("Скопировано!");
        };
    </script>
</body>
</html>
